# 2018-12-29 レビュー用資料 on「モブプロ・ペアプロ会 with mohira」

## 1. はじめに

本リポジトリは、掲題のイベントで [資料「TDDBC課題：ポーカー」](http://devtesting.jp/tddbc/?TDDBC仙台07%2F課題) における「課題1-1 カードの文字列表記」に対してPHPerペアが取り組んだ成果物の変遷を履歴として持つリポジトリです。

### 1-1. ポーカーのルールについての知識

#### 任天堂が掲載している情報
     
* [ポーカー：トランプの歴史・遊び方](https://www.nintendo.co.jp/n09/trump_games/poker/index.html)
    * <details><summary>上記URLからの抜粋を表示</summary>

          遊び方
              1.各プレイヤーは参加チップとして1枚ずつ場に出します。
          
              2.親は、よく切ったカードを左側の人から順に1枚ずつ伏せて、手持ちが5枚ずつになるように
                配ります。残りはストックとします。
          
              3.配られた手札を見て、親の左側の人から「ビッド」か「パス」かを順に宣言していきます。
                誰か1人がビッドしたら、それ以後の人はパスできません。
          
              4.最初にビッドする人は、チップの枚数を言って場に出します。
                (チップは最高何枚までと、決めておいた方がよいでしょう。)
          
              5.次の人からは、コールかレイズかドロップでゲームを進めます。レイズする人は、チップの枚数を
                言わねばなりません。
          
              6.最高のビッドに対して、誰もレイズをしないままに1巡したら、第1回目のビッドは終りです。
          
              7.ゲームに残った人が3人以上いた場合は、親の左側に近い人から手札を交換、ドローをします。
          
              8.より強い役をつくるために、手札の中の不要なカードを場に伏せて出し、捨てた枚数だけ
                親からもらいます。親は自分で交換しますが、何枚交換したかを告げます。
                そして、それぞれ新しい手札を検討します。
          
              9.ストック・カードがなくなった時は、捨て札を集めてよく切り、使います。
          
             10.ドローが済むと、第2回目のビッドです。新しい手札を検討し、第1回目の最初にビッドした
                人から「ビッド」か「チェック」の宣言をしていきます。
                この時、誰か1人がビッドをしたら、それ以降の人はチェックできません。
          
             11.そして前回同様にコール・レイズ・ドロップをしてゲームを進めます。
          
             12.最高のビッドに対して誰もレイズしないまま1巡した時、このせりは終了です。手札を公開し、
                他のプレイヤーと比べます。その中で最強のポーカー・ハンド(役)をもった人が勝ちとなり、
                場にあるチップを全部獲得します。
          
             13.また、他のすべてのプレイヤーがドロップをした場合も同じです。
          
             14.こうして何回かゲームを続け、最終的には1番多くのチップを持っている人から順に、
                1位、2位、3位……となります。

      </details>

#### 簡単バージョンへの言及のあるサイトの情報

* [ポーカーのルールと遊びかた | トランプの遊び方](https://www.card-asobi.com/poker.html)
     * <details><summary>上記URLからの抜粋を表示</summary>

               ポーカーかんたんバーションのルール・進め方
               
               ドローポーカーのかんたんバージョンを紹介（しょうかい）します。
               チップはかけないで行うトランプゲームです。
               3回トランプを交換して、組み合わせが一番強い人が勝ちです。

               1.カードを配る
               親の役の人は1人5枚ずつカードを裏向きに配って、残りは山札（やまふだ）にします。 

               2.手札を交換（こうかん）する
               親の左どなりの人から順番に、自分の手札のいらないカードを山札と交換できます。
               1枚～5枚自由に変えることができます。

               3.手札の一番強い人が勝ち
               ぜんいんが3回カードを交換したら終わりです。

               それぞれの手札をみせて、1番強い組み合わせの人が勝ちです。

     </details>
 
### 1-2. リポジトリの構成

composer create-project によって生成されたLaravel5.5系のプロジェクトの構成物をベースにして、次のようなディレクトリ構成になっています。

```
### Laravel5.5系プロジェクトの標準構成物 + α ###

projectDir/
  ├ app/
  │  ├ ～～省略～～
  │  ├ Domain/              ← レビュー対象
  │  └ ～～省略～～
  ├ ～～省略～～
  ├ docs/
  │  ├ analyze/             ← レビュー対象
  │  └ usecase/             ← レビュー対象
  ├ ～～省略～～
  ├ tests/
  │  ├ ～～省略～～
  │  ├ Unit/
  │  │   └ Poker/           ← レビュー対象
  │  └ ～～省略～～
  ├ ～～省略～～
  └ phpunit.xml

```

## 2. レビュー

### 2-1. 図の作成意図

課題の示す規模のプログラムを書くのに
「ユースケース図やロバストネス図を作ってDDD風の実装設計をする」という作業は仰々しいと言ってしまえばそうなのですが、
課題の示す一覧を俯瞰して見た時、すべての課題が **「Pokerというゲームをプレイヤーが遊ぶための部品作りに順を追って取り組んでいく」** という文脈を持っていると見受けました。

部品ということは、いずれPokerというゲームを実現するシステムに組み込んで使うでしょうから、
システムにおける位置づけを適切なnamespaceで表現しておくことは「最初にやっておくべきこと」のように思われましたので、上記の仰々しい作業に遠慮なく取り組むことにしました。

*(※ペアとなったPHPersがそれぞれ「横メロン農家を最近始めた」という似た境遇にあったため上記の目的をこじつけただけ、という説もあり)*

### 2-2. 図の解説

/docs/配下の図を、次の順に御覧ください。

1. /docs/usecase/ユーザがシステムを操作.png
2. /docs/analyze/プレイヤーの手持ちカードの文字列表記を問い合わせる.png
3. /docs/analyze/カード一枚の文字列表記を返す.png

最初のユースケース図「ユーザがシステムを操作」で示した内容のうち、
ユーザが行う「カードの文字列表記を取得」という処理をロバストネス分析してその先の各ユースケースをロバストネス図化したものが
/docs/analyze/配下
へ配置してあります。

提示したユースケース図や２つのロバストネス図は、システム内部のプロセスの関係性を次のように示唆しており、ユースケース記述の作成を代替しています。

*(※ユースケース記述に相当する「文言メインの文書」を作ると、図に変更が生じる時に修正が面倒なので書きたくないという怠惰が発動しただけ、という説は認めない)*

* 完成するシステムではおそらく各々次のような責務を持つドメインモデルが存在するはず。
    * **ドメインモデル「Trump」: カード集合の状態を扱う**
        * 全カードを表現するコレクションのようなデータ構造の中で、次のような振る舞いを持つ可能性が見込まれる
            * プレイヤーに配布済みのカードは、配布元である「スタックされたカード集合」中に無いことを保証する
            * スタックされたカード集合の上から一枚ずつ取り出す
            * スタックされたカード集合の中からいずれか一枚を抜き出す
            * カードのスタックをシャッフルする
        * カード集合から取り出された一枚のカードについての属性情報を表現する
            * スート(suit)を取り出す
            * ランク(rank)を取り出す
            * suitとrankを連結して取り出す
            * ゲームが変われば、「折れ曲がっている」とか「裏返しである」といった状態も持つかもしれない
    * **ドメインモデル「Poker」: Pokerゲームの進行を司る**
        * PlayerやDealerの行う操作や関係性を扱う
            * DealerがTrumpモデルからカードEntityをPlayerへ配布する
            * １ゲーム毎のライフサイクル(「◯回勝負を行う」とか)を扱うことにもなるであろう
            * 勝敗情報を蓄積し、成績データを持つことも考えられる
        * 各Playerが手元に持っているカード集合のスタックそのものや相関を扱うことになると思われる
            * 各Playerの手札数
            * Playerの持つ手札の役を判定する
            * Playerの手札間の勝敗を判定する
* 以上を踏まえて、Domainネームスペース配下には「Poker」と「Trump」というネームスペースを置いた方が良さそう。
* また、図より今回の課題である「カードの文字列表記」を取得する処理は、ゆくゆくはシステム内部で次のような「クライアント」と「クライアントが利用する処理」を持つと見ることができるようになった。
    * システム内部第一層
        * クライアント(Actor)  :システム
        * 利用する処理(Control):Pokerパッケージ内部のPlayerエンティティの持つ「Card一枚を取得するメソッド」
    * システム内部第二層
        * クライアント(Actor)  :Playerエンティティ
        * 利用する処理(Control):Trumpパッケージ内Cardエンティティの持つ「カードの文字列表記を取得するメソッド」

### 2-3. 図示した概念をDomainモデルのクラス設計へ反映

上記の最後にてControlとして表現される処理を各boundary(境界)と対応するInterfaceへメソッドとして定義すれば、
いよいよ「具象クラスが未実装だろうと、Interfaceの組み立てだけで『テストしたいこと』をコードとして表現する」ための下地が出来た、と言えるのではないでしょうか。
つまりこれは「テスト駆動開発」プロセスが理想的に進んでいるということでは？！

というわけで、各boundaryの持つメソッドをInterfaceとして配置したのが
/app/Domain/配下の各種コードです。
また、それら配置済みのInterfaceを使って書いたテストコードが
/tests/Unit/Poker/配下のコードです。

テストコードは、PHP7.2以上が動作する環境であれば次のようなコマンドで動作します。
※ ただし、composer install を予め実行しておく必要はあります。(composerの使い方についての説明は割愛します)
> $ php vendor/bin/phpunit tests/Unit

次のように「--debug」オプションを付けると、phpunitがdebugモードでの出力も行ってくれます。
> $ php vendor/bin/phpunit tests/Unit --debug



## 最後に

実際のプロジェクトではこの後「ロバストネス図からシーケンス図やクラス図を生成」というプロセスを経て具象クラスの実装が始まるものと思われますが、まだそこは把握できてないのでやっていません。

以上が、「テスト駆動開発のための設計」に取り組んだ結果のレビュー内容となります。
ご査収ください。


*※なお、上記の「Domainネームスペース」は今回の作業上の都合でLaravel標準構成中の/app/配下に放り込んであるが、コード的には完全にLaravelの管轄するディレクトリ構成の外に置くことができる(composer.jsonに一工夫入れれば)ということを、申し添えておきます*


